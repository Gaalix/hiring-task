<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fiat Payment Mini-App</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h1>Deposit Funds</h1>
    <div id="payment-buttons">
      <button onclick="handlePayment(2000)">Deposit 20€</button>
      <button onclick="handlePayment(4000)">Deposit 40€</button>
      <button onclick="handlePayment(10000)">Deposit 100€</button>
    </div>
    <div id="card-element"></div>
    <div id="payment-result"></div>

    <script>
      const stripe = Stripe("<%= stripePublicKey %>");
      const elements = stripe.elements();
      const cardElement = elements.create("card");
      cardElement.mount("#card-element");

      // Function to handle the payment process
      async function handlePayment(amount) {
        const paymentResult = document.getElementById("payment-result");
        paymentResult.textContent = "Processing payment...";

        try {
          // Create a payment intent on the server
          const response = await fetch("/create-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount }),
          });
          const { clientSecret } = await response.json();

          paymentResult.textContent = "Confirming payment...";

          // Confirm the payment
          const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: cardElement },
          });

          // Handle the result of the payment
          if (result.error) {
            paymentResult.textContent = `Payment failed: ${result.error.message}`;
          } else {
            paymentResult.textContent = "Payment successful!";
          }
        } catch (error) {
          // Handle any errors that occur during the payment process
          paymentResult.textContent = `Error: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
